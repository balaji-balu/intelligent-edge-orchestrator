name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  ci:
    runs-on: ubuntu-latest

    env:
      GITHUB_TOKEN: ${{ secrets.GTHUB_TOKEN }}
      PG_USER: ${{ secrets.PG_USER }}
      PG_PASSWORD: ${{ secrets.PG_PASSWORD }}
      PG_DB: ${{ secrets.PG_DB }}
      PG_HOST: postgres
      EDGECTL_CO_URL: http://localhost:9001

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Install Atlas
        run: curl -sSf https://atlasgo.sh | sh

      - name: Add Ent deps
        run: |
          go get entgo.io/ent/cmd/ent@latest
          go mod tidy

      - name: Generate Ent
        run: go run entgo.io/ent/cmd/ent generate ./ent/schema

      - name: Validate migrations
        run: atlas migrate validate --dir file://ent/migrate

      - name: Docker Compose Up
        run: |
          docker compose -f docker-compose.yml up -d --build
          docker compose -f docker-compose.yml ps | tee containers.txt

      - name: Wait for Postgres
        run: |
          for i in {1..20}; do
            docker exec postgres pg_isready -U $PG_USER && break
            sleep 3
          done

      - name: Apply migrations (Atlas on host â†’ Postgres in Docker)
        run: |
          atlas migrate apply \
            --url "postgres://$PG_USER:$PG_PASSWORD@localhost:5432/$PG_DB?sslmode=disable" \
            --dir file://ent/migrate 

      - name: Seed Database
        run: |
          psql "postgres://$PG_USER:$PG_PASSWORD@localhost:5432/$PG_DB?sslmode=disable" < tests/seeds/site.sql

      # - name: Seed Database
      #   run: |
      #     psql "postgres://$PG_USER:$PG_PASSWORD@localhost:5432/$PG_DB" < seed.sql

      - name: Health checks
        run: |
          curl -s http://localhost:9001/api/v1/healthz
          curl -s http://localhost:9010/healthz
          curl -s http://localhost:9011/healthz

      - name: Build CLI
        run: go build -o edgectl ./cmd/edgectl

      - name: Smoke Test - Deploy Sample App
        run: |
          ./edgectl co add app \
            --name retail/pos/1.0 \
            --artifact https://github.com/edge-orchestration-platform/app-registry/

          ./edgectl co deploy app \
            --name retail/pos/1.0 \
            --sites 379871e1-d4c4-4cef-8545-353e4535f08e


      # - name: Smoke test
      #   run: |
      #     docker exec intelligent-edge-orchestrator-co-1 \
      #       cli co add app --name sample/hello/1.0 --artifact https://github.com/app-registry

      #     docker exec intelligent-edge-orchestrator-co-1 \
      #       cli co deploy --app sample/hello/1.0 --sites lo_1

      - name: Logs on failure
        if: failure()
        run: docker compose -f docker-compose.yml logs

      - name: Shutdown
        if: always()
        run: docker compose -f docker-compose.yml down -v
