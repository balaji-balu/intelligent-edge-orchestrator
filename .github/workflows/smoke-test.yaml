name: CI Smoke Test

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    env:
      # GitHub token for private repo access
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      PG_USER: ${{ secrets.PG_USER }}
      PG_PASSWORD: ${{ secrets.PG_PASSWORD }}
      PG_DB: ${{ secrets.PG_DB }}
      PG_HOST: postgres
      EDGECTL_CO_URL: http://localhost:9001/
      # EDGECTL_LO_URL: http://localhost:9001/
      # EDGECTL_EN_URL: http://

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Start Docker Compose
        run: |
          docker compose -f docker-compose.yml up -d --build
          docker compose ps

      - name: Wait for services to be ready
        run: |
          echo "Waiting for 15s..."
          sleep 15

          # Wait until health endpoints respond
          until curl -s http://localhost:9001/api/v1/healthz | grep ok; do
            echo "Waiting for CO..."
            sleep 5
          done

          until curl -s http://localhost:9010/healthz | grep ok; do
            echo "Waiting for LO_1..."
            sleep 5
          done

          until curl -s http://localhost:9011/healthz | grep ok; do
            echo "Waiting for LO_2..."
            sleep 5
          done

      - name: Build CLI
        run: go build -o edgectl ./cmd/edgectl

      - name: Smoke Test - Deploy Sample App
        run: |
          ./edgectl co add app \
            --name retail/pos/1.0 \
            --artifact https://github.com/edge-orchestration-platform/app-registry/

          ./edgectl co deploy app \
            --name retail/pos/1.0 \
            --sites 379871e1-d4c4-4cef-8545-353e4535f08e

      - name: Verify CO and LO states
        run: |
          curl -s http://localhost:9001/api/v1/apps
          curl -s http://localhost:9010/api/v1/state
          curl -s http://localhost:9011/api/v1/state

      - name: Stop all containers
        run: docker compose down -v
